<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.69">
<title data-react-helmet="true">State-Based Property Testing Tutorial | Hedgehog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="State-Based Property Testing Tutorial | Hedgehog"><meta data-react-helmet="true" name="description" content="State-Based Property Testing Tutorial"><meta data-react-helmet="true" property="og:description" content="State-Based Property Testing Tutorial"><meta data-react-helmet="true" property="og:url" content="https://hedgehogqa.github.io/scala-hedgehog/docs/guides-state-tutorial"><link data-react-helmet="true" rel="shortcut icon" href="/scala-hedgehog/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://hedgehogqa.github.io/scala-hedgehog/docs/guides-state-tutorial"><link rel="stylesheet" href="/scala-hedgehog/styles.2bdfe6a6.css">
<link rel="preload" href="/scala-hedgehog/styles.5f69d01b.js" as="script">
<link rel="preload" href="/scala-hedgehog/runtime~main.5e8a3377.js" as="script">
<link rel="preload" href="/scala-hedgehog/main.f434eb93.js" as="script">
<link rel="preload" href="/scala-hedgehog/1.122cbe11.js" as="script">
<link rel="preload" href="/scala-hedgehog/21.1b41b8aa.js" as="script">
<link rel="preload" href="/scala-hedgehog/23.f2f4b620.js" as="script">
<link rel="preload" href="/scala-hedgehog/935f2afb.0ebc5326.js" as="script">
<link rel="preload" href="/scala-hedgehog/20.be2a4b13.js" as="script">
<link rel="preload" href="/scala-hedgehog/e1d0ebe9.45f78786.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/scala-hedgehog/"><img src="/scala-hedgehog/img/hedgehog-logo-32x32.png" alt="Hedgehog Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/scala-hedgehog/img/hedgehog-logo-32x32.png" alt="Hedgehog Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Hedgehog</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/scala-hedgehog/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hedgehogqa/scala-hedgehog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/scala-hedgehog/"><img src="/scala-hedgehog/img/hedgehog-logo-32x32.png" alt="Hedgehog Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/scala-hedgehog/img/hedgehog-logo-32x32.png" alt="Hedgehog Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Hedgehog</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/scala-hedgehog/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/hedgehogqa/scala-hedgehog" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLinkText_2zSB">Hedgehog for Scala</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/">Hedgehog</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/getting-started">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/motivation">Motivation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/resources">Resources</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/alternatives">Alternatives</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2zSB">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/guides">Guides</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/guides-tutorial">Tutorial</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/scala-hedgehog/docs/guides-state-tutorial">State-Based Testing (1)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/guides-state-tutorial-vars">State-Based Testing (2)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/guides-migration-from-scalacheck">Migration From ScalaCheck</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/guides-haskell-differences">Differences to Haskell Hedgehog</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2zSB">Integration</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/scala-hedgehog/docs/integration-minitest">Minitest</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">State-Based Property Testing Tutorial</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="state-based-property-testing-tutorial"></a>State-Based Property Testing Tutorial<a class="hash-link" href="#state-based-property-testing-tutorial" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="follow-along"></a>Follow Along<a class="hash-link" href="#follow-along" title="Direct link to heading">#</a></h2><p>Please feel to play along and tinker with the code.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">$ ./sbt</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; example/runMain hedgehog.examples.state.KVTest</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-problem"></a>The Problem<a class="hash-link" href="#the-problem" title="Direct link to heading">#</a></h2><p>To start with let&#x27;s define an interface/abstraction for something we want to
test against, the most basic key/value store:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">trait KV {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  def put(k: String, v: String): Unit</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  def get(k: String): Option[String]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Now let&#x27;s write some normal property tests to test it:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">def testPut(kv: KV): Property =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  for {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    k &lt;- genKey</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    v &lt;- genValue</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  } yield {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    kv.put(k, v)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    kv.get(k) ==== Some(v)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def testGetMissing(kv: KV): Property =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  for {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    v &lt;- genValue</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  } yield {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    kv.get(k) ==== None</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>So far so good. But do we think we have tested all the cases? Think about that
for a second and let&#x27;s see what happens...</p><p>We&#x27;re looking at an interface with just two functions, but there are infinite
ways in which we can interact with them. How well do are tests scale when we add
<em>one</em> more function (ie delete)? Or ten?</p><p>What we really want to do is let our property testing library generate the
interactions themselves!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="model"></a>Model<a class="hash-link" href="#model" title="Direct link to heading">#</a></h2><p>At a conceptual level the idea with state-based testing is to &quot;model&quot; the real
world with something pure (ie in memory). We then execute real commands against
our system/api, and compare the result with what our model expects.</p><p><img src="https://res.infoq.com/presentations/testing-techniques-case-study/en/slides/sl6.jpg"></p><p>At the technical level the current approach to writing a state-based test is to
implement a series of very specific functions for each operation or &quot;command&quot;
you want to test.</p><p>Firstly let&#x27;s create our <em>pure</em> domain model for testing. In this case it&#x27;s
trivial to think of a key-value store as an immutable <code>Map</code>.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">case class State(map: Map[String, String])</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>For each command you quite often end up just reifying the function arguments in
to a data type:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">case class Put(key: String, value: String)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">case class Get(key: String)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>For each command you need to implement the <a href="https://github.com/hedgehogqa/scala-hedgehog/blob/master/core/shared/src/main/scala/hedgehog/state/Command.scala" target="_blank" rel="noopener noreferrer">Command</a> interface. This can look
quite daunting so let&#x27;s step through it:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">def command(kv: KV): CommandIO[State] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  new Command[State, Input, Output] {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    def gen(s: State): Option[Gen[Input]]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    def execute(i: Input): Either[String, Output]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    def update(s: State, i: Input): State</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    def ensure(s0: State, s1: State, i: Input, o: Output): Result</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="gen"></a>Gen<a class="hash-link" href="#gen" title="Direct link to heading">#</a></h3><p>Firstly, we need to be able to generate random inputs to our command.</p><p>The key thing to note is that we take in the current state, which we might want
to use to generate some values.  There might be cases where no valid input can
be generated. For example you need to call put before you can call get.  One
simple way to generate our operations would be something like:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">def gen(s: State): Option[Gen[Put]] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Some(for {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    k &lt;- Gen.string(Gen.ascii, Range.linear(1, 10))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    v &lt;- Gen.string(Gen.ascii, Range.linear(1, 10))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  } yield Put(k, v))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def gen(s: State): Option[Gen[Get]] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Some(Gen.string(Gen.ascii, Range.linear(1, 10))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    .map(Get(_)))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>But how often do we generate the same keys in either case? Shouldn&#x27;t we try to
generate similar keys sometimes?</p><p>A slightly better attempt:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">def genKey: Gen[String] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Gen.string(Gen.ascii, Range.linear(1, 10))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def gen(s: State): Option[Gen[Put]] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Some(for {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    k &lt;- s.map.keys.toList match {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      case Nil =&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        genKey</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      case h :: t =&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // Choice between known and unknown keys</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        Gen.frequency1(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          50 -&gt; genKey</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        , 50 -&gt; Gen.element(h, t)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        )</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // Always generate a unique value</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    v &lt;- Gen.string(Gen.ascii, Range.linear(1, 10))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  } yield Put(k, v))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def gen(s: State): Option[Gen[Get]] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Some((s.map.keys.toList match {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    case Nil =&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      genKey</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    case h :: t =&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      // Mostly get values we know to exist, but also try values that don&#x27;t</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      Gen.frequency1(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        80 -&gt; Gen.element(h, t)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      , 20 -&gt; genKey</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      )</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }).map(Get(_)))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>That&#x27;s definitely a little more involved, but you can see we&#x27;re getting a good
spread of put/get values with known/duplicate and unknown keys. That should
cover everything, which is a critical component of <em>good</em> property testing in
general.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="execute"></a>Execute<a class="hash-link" href="#execute" title="Direct link to heading">#</a></h3><p>This is the easy bit, just call our operation. Note the lack of our model/state,
you can also interact with the &quot;real world&quot;.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">def execute(i: Put): Either[String, Unit] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Right(kv.put(i.key, i.value))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def execute(i: Get): Either[String, Option[String]] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Right(kv.get(i.key))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="update"></a>Update<a class="hash-link" href="#update" title="Direct link to heading">#</a></h3><p>This is where we need to &quot;model&quot; what we expect that operation to do in our pure state.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">def update(s: State, i: Put): State =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  s.copy(map = s.map + (i.key -&gt; i.value))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">// There are no side-effects for get, so nothing to do</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def update(s: State, i: Get): State =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="ensure"></a>Ensure<a class="hash-link" href="#ensure" title="Direct link to heading">#</a></h3><p>This is the &quot;post condition&quot;. What did we expect to happen in the real world vs
our model?</p><p>Just as a side note, the <code>s0</code> means the state before update is run, and <code>s1</code> is
the current state. It&#x27;s always possible, and fairly common, to just use <code>s1</code> and
the input value.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">// Almost the reverse of update, for side-effect operations we may not observe anything just yet</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def ensure(s0: State, s1: State, i: Put, o: Unit): Result =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Result.success</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def ensure(s0: State, s1: State, i: Get, o: Option[String]): Result =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  s1.map.get(i.key) ==== o</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="faq"></a>FAQ<a class="hash-link" href="#faq" title="Direct link to heading">#</a></h2><p>The common question here is &quot;won&#x27;t we just end up with two implementations&quot;? Yes
and no. Obviously this is a trivial example. The model is so simple that we can
actually have a 100% full re-implementation. This won&#x27;t always be the case, we
may only want to guarantee some invariants are true, but not the exact
behaviour. Also remember that we haven&#x27;t actually looked at the implementation
of KV yet. It might be storing keys on files, or across the network with
multiple copies. If there are any bugs in any of that code it&#x27;s quite likely we
will find it at some point.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="sequential"></a>Sequential<a class="hash-link" href="#sequential" title="Direct link to heading">#</a></h2><p>So the final piece is to hook up all our commands to form a property. It would look something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">def testKVFileSequential: Property = {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  val root = File(&quot;tmpdir&quot;)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // Create a simple file-system KV store</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  val kv = KV.file(root)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  sequential(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // The range of commands to generate</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      Range.linear(1, 100)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // Out initial state to be used for each test run</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    , State(Map())</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // The list of commands</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    , List(putCommand, getCommand)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // Any cleanup code for the real-world, which in this case is to delete the KV file root for each test run</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    , () =&gt; root.delete()</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    )</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>This can be added to Hedgehog like any other property:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">override def tests: List[Test] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  List(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    property(&quot;test file KV (sequential)&quot;, testKVFileSequential)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Some errors that a naive  file implementation found:</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="invalid-file-path"></a>Invalid file path<a class="hash-link" href="#invalid-file-path" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Var(Name(0)) = Put(???,b)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Error thrown running execute: Invalid file path</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>The first set of line(s) are the series of commands that have been run in order
(ignore <code>Var</code> for now). Everything after that is our <code>Result</code> log.</p><p>So I&#x27;m generating invalid keys. So there is some restrictions on what our keys
can be. Interesting. For now update the generator to something much more
restrictive.</p><p>Note that this would have been found pretty quickly by our &quot;normal&quot; put/get
property. So far state-based testing hasn&#x27;t done much for us.</p><p>Let&#x27;s fix the key generator.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">def genKey : Gen[String] =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  for {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    c &lt;- Gen.lower</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    s &lt;- Gen.string(Gen.choice1(Gen.lower, Gen.constant(&#x27;/&#x27;)), Range.linear(0, 10))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  } yield c + s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="leaky-file-abstraction"></a>Leaky File Abstraction<a class="hash-link" href="#leaky-file-abstraction" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Var(Name(15)) = Put(a,b)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Var(Name(16)) = Get(a/)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; === Not Equal ===</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; --- lhs ---</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; None</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; --- rhs ---</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Some(b)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Ahh, now we&#x27;re getting somewhere a more interesting. We&#x27;ve generated a sequence
of putting to a key and then getting the same key with a trailing slash we get
back an unexpected value. The key-value abstraction has definitely leaked the
underlying file implementation!</p><p>This now would have required a slightly more sophisticated property testing
rather than a simple round-trip like shown above. We didn&#x27;t even have to think
about it, it just comes with modelling each command once.</p><p>Also note that it appears to have found the absolute minimum case, where &quot;a&quot; is
the key. If you disable shrinking you may get up to 100 steps, where only two of
them are relevant to the failure case.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="parallel"></a>Parallel<a class="hash-link" href="#parallel" title="Direct link to heading">#</a></h2><p>Ok, so this is where things get really interesting. By changing two lines we
transform our sequential test in to a parallel one. Without changing any of our
testing logic!</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">// Import this somewhere</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">import scala.concurrent.ExecutionContext.Implicits._</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def testParallel: Property = {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  val root = new File(&quot;tmpdir&quot;)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  val kv = KV.file2(root)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  parallel(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // This is still required, but now means the range of commands for the prefix (see below)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      Range.linear(1, 10)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // This is now required. It specifies the range of command we want to generate for each parallel branch (see below)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    , Range.linear(1, 10)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    , State.default</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    , commands(kv)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    , () =&gt; root.delete()</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    )</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>What does it find?</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; --- Prefix ---</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">Var(Name(1)) = Put(a,A)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">--- Branch 1 ---</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">Var(Name(2)) = Put(a,A)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">--- Branch 2 ---</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">Var(Name(3)) = Get(a)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; === Not Equal ===</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; --- lhs ---</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Some(A)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; --- rhs ---</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; Some()</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">&gt; no valid interleaving</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>This can be slightly harder to read than sequential test output. In parallel
tests we start by generating a sequence of actions to be run in a single thread.
This is basically to initialise our state/store safely. At this point we then
generate two sequences of actions, and execute them on two JVM threads and race
them. At this point it&#x27;s now basically impossible to observe the exact sequence
of actions that happened on either thread. Instead what hedgehog does is re-run
the model update  for each combination of actions, and at least one of the
expected results must not be a failure. We must be able to find one (potential)
way that we reached the output we observed (ie it must
<a href="https://en.wikipedia.org/wiki/Linearizability" target="_blank" rel="noopener noreferrer">linearize</a>)</p><p>From that error it looks like we are somehow getting back an empty result from
Get  That should be impossible, and yet here we are. If we look at the
implementation it should be easy to spot:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">val w = new FileWriter(f)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">w.write(v)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">w.close()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>There is a very small window where we open the file writer and write before
flushing/closing. And yet hedgehog found it! As a better alternative we could
write to a temporary file, and then rename once the data has been written, which
should be atomic.</p><p>Would we have found that edge-case ourselves with any kind of example or
property testing? I highly doubt it!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="vars"></a>Vars<a class="hash-link" href="#vars" title="Direct link to heading">#</a></h3><p>One thing I have left-off is probably the most confusing aspect of the hedgehog
implementation of state-based testing (it doesn&#x27;t exist in ScalaCheck for
example). This is that we have to deal with something called <code>Var</code> and
<code>Environment</code>. These are visible in the <code>execute</code>, <code>update</code> and <code>ensure</code>
functions:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">def execute(env: Environment, i: Input): Either[String, Output]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def update(s: State, i: Input, o: Var[Output]): State</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">def ensure(env: Environment, s0: State, s1: State, i: Input, o: Output): Result</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>For the tests we just wrote we actually don&#x27;t need them, but they are useful in
more complex testing scenarios. Please see the <a href="/scala-hedgehog/docs/guides-state-tutorial-vars">next
tutorial</a> to learn more.</p><p>For now just ignore them, you can still get started and write some reasonable
properties like we just did.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="resources"></a>Resources<a class="hash-link" href="#resources" title="Direct link to heading">#</a></h2><ul><li>The gold standard for an introduction to state-based testing is John Hughes<ul><li><a href="https://www.infoq.com/presentations/testing-techniques-case-study/" target="_blank" rel="noopener noreferrer">https://www.infoq.com/presentations/testing-techniques-case-study/</a></li><li><a href="https://www.youtube.com/watch?v=hXnS_Xjwk2Y" target="_blank" rel="noopener noreferrer">Don&#x27;t Write Tests</a></li></ul></li><li><a href="https://teh.id.au/posts/2017/07/15/state-machine-testing/index.html" target="_blank" rel="noopener noreferrer">https://teh.id.au/posts/2017/07/15/state-machine-testing/index.html</a></li><li><a href="https://github.com/qfpl/state-machine-testing-course" target="_blank" rel="noopener noreferrer">https://github.com/qfpl/state-machine-testing-course</a></li><li><a href="https://www.youtube.com/watch?v=owHmYA52SIM" target="_blank" rel="noopener noreferrer">Introduction to stateful property based testing</a></li><li><a href="https://www.youtube.com/watch?v=YhAxC_VI2dc" target="_blank" rel="noopener noreferrer">State-based Testing Tutorial</a></li></ul></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/scala-hedgehog/docs/guides-tutorial"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Tutorial</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/scala-hedgehog/docs/guides-state-tutorial-vars"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">State-Based Property Testing Tutorial (Part 2 - Vars) Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#state-based-property-testing-tutorial" class="table-of-contents__link">State-Based Property Testing Tutorial</a></li><li><a href="#follow-along" class="table-of-contents__link">Follow Along</a></li><li><a href="#the-problem" class="table-of-contents__link">The Problem</a></li><li><a href="#model" class="table-of-contents__link">Model</a><ul><li><a href="#gen" class="table-of-contents__link">Gen</a></li><li><a href="#execute" class="table-of-contents__link">Execute</a></li><li><a href="#update" class="table-of-contents__link">Update</a></li><li><a href="#ensure" class="table-of-contents__link">Ensure</a></li></ul></li><li><a href="#faq" class="table-of-contents__link">FAQ</a></li><li><a href="#sequential" class="table-of-contents__link">Sequential</a></li><li><a href="#parallel" class="table-of-contents__link">Parallel</a><ul><li><a href="#vars" class="table-of-contents__link">Vars</a></li></ul></li><li><a href="#resources" class="table-of-contents__link">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/scala-hedgehog/docs/">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/scala-hedgehog/docs/guides/">Guides</a></li><li class="footer__item"><a class="footer__link-item" href="/scala-hedgehog/docs/integration-minitest/">Integration</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/hedgehogqa/scala-hedgehog" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2021 Hedgehog, Website built with Docusaurus.<br><div>Some icons made by <a href="https://www.flaticon.com/authors/darius-dan" title="Darius Dan">Darius Dan</a> and <a href="https://www.flaticon.com/authors/pixel-perfect" title="Pixel perfect">Pixel perfect</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a></div></div></div></div></footer></div>
<script src="/scala-hedgehog/styles.5f69d01b.js"></script>
<script src="/scala-hedgehog/runtime~main.5e8a3377.js"></script>
<script src="/scala-hedgehog/main.f434eb93.js"></script>
<script src="/scala-hedgehog/1.122cbe11.js"></script>
<script src="/scala-hedgehog/21.1b41b8aa.js"></script>
<script src="/scala-hedgehog/23.f2f4b620.js"></script>
<script src="/scala-hedgehog/935f2afb.0ebc5326.js"></script>
<script src="/scala-hedgehog/20.be2a4b13.js"></script>
<script src="/scala-hedgehog/e1d0ebe9.45f78786.js"></script>
</body>
</html>